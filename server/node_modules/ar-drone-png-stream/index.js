var http = require('http');

module.exports = function (client, opts, io) {
  var png = null;

  opts = opts || {};

  var server = http.createServer(function (req, res) {

    if (!png) {
      png = client.getPngStream();
      png.on('error', function (err) {
        console.error('png stream ERROR: ' + err);
        io.sockets.emit('videoFeed', { connection: false });
      });
    }

    res.setHeader('Access-Control-Allow-Origin', '*');
    res.writeHead(200, { 'Content-Type': 'multipart/x-mixed-replace; boundary=--daboundary' });

    png.on('data', sendPng);

    function sendPng(buffer) {
      console.log(buffer.length);
      res.write('--daboundary\nContent-Type: image/png\nContent-length: ' + buffer.length + '\n\n');
      res.write(buffer);
      io.sockets.emit('videoFeed', { connection: true });
    }
  });

  server.listen(opts.port || 8000);
};
